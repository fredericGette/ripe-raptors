<roblox version="4">
  <Item class="Lighting" referent="0">
    <Properties>
      <string name="Name">Lighting</string>
      <Color3 name="Ambient">
        <R>0</R>
        <G>0</G>
        <B>0</B>
      </Color3>
      <float name="Brightness">2</float>
      <bool name="GlobalShadows">true</bool>
      <bool name="Outlines">false</bool>
      <token name="Technology">1</token>
    </Properties>
  </Item>
  <Item class="ReplicatedStorage" referent="1">
    <Properties>
      <string name="Name">ReplicatedStorage</string>
    </Properties>
    <Item class="Folder" referent="2">
      <Properties>
        <string name="Name">common</string>
      </Properties>
      <Item class="Part" referent="3">
        <Properties>
          <string name="Name">Bullet</string>
          <bool name="Anchored">false</bool>
          <BinaryString name="AttributesSerialize">
          </BinaryString>
          <float name="BackParamA">-0.5</float>
          <float name="BackParamB">0.5</float>
          <token name="BackSurface">0</token>
          <token name="BackSurfaceInput">0</token>
          <float name="BottomParamA">-0.5</float>
          <float name="BottomParamB">0.5</float>
          <token name="BottomSurface">4</token>
          <token name="BottomSurfaceInput">0</token>
          <CoordinateFrame name="CFrame">
            <X>0</X>
            <Y>0</Y>
            <Z>0</Z>
            <R00>1</R00>
            <R01>0</R01>
            <R02>0</R02>
            <R10>0</R10>
            <R11>1</R11>
            <R12>0</R12>
            <R20>0</R20>
            <R21>0</R21>
            <R22>1</R22>
          </CoordinateFrame>
          <bool name="CanCollide">true</bool>
          <bool name="CanTouch">true</bool>
          <bool name="CastShadow">true</bool>
          <int name="CollisionGroupId">0</int>
          <Color3uint8 name="Color3uint8">10724005</Color3uint8>
          <PhysicalProperties name="CustomPhysicalProperties">
            <CustomPhysics>false</CustomPhysics>
          </PhysicalProperties>
          <token name="formFactorRaw">1</token>
          <float name="FrontParamA">-0.5</float>
          <float name="FrontParamB">0.5</float>
          <token name="FrontSurface">0</token>
          <token name="FrontSurfaceInput">0</token>
          <float name="LeftParamA">-0.5</float>
          <float name="LeftParamB">0.5</float>
          <token name="LeftSurface">0</token>
          <token name="LeftSurfaceInput">0</token>
          <bool name="Locked">false</bool>
          <bool name="Massless">false</bool>
          <token name="Material">256</token>
          <CoordinateFrame name="PivotOffset">
            <X>0</X>
            <Y>0</Y>
            <Z>0</Z>
            <R00>1</R00>
            <R01>0</R01>
            <R02>0</R02>
            <R10>0</R10>
            <R11>1</R11>
            <R12>0</R12>
            <R20>0</R20>
            <R21>0</R21>
            <R22>1</R22>
          </CoordinateFrame>
          <float name="Reflectance">0</float>
          <float name="RightParamA">-0.5</float>
          <float name="RightParamB">0.5</float>
          <token name="RightSurface">0</token>
          <token name="RightSurfaceInput">0</token>
          <int name="RootPriority">0</int>
          <Vector3 name="RotVelocity">
            <X>0</X>
            <Y>0</Y>
            <Z>0</Z>
          </Vector3>
          <token name="shape">1</token>
          <Vector3 name="size">
            <X>4</X>
            <Y>4</Y>
            <Z>4</Z>
          </Vector3>
          <int name="SourceAssetId">-1</int>
          <BinaryString name="Tags">
          </BinaryString>
          <float name="TopParamA">-0.5</float>
          <float name="TopParamB">0.5</float>
          <token name="TopSurface">3</token>
          <token name="TopSurfaceInput">0</token>
          <float name="Transparency">0</float>
          <Vector3 name="Velocity">
            <X>0</X>
            <Y>0</Y>
            <Z>0</Z>
          </Vector3>
        </Properties>
        <Item class="Attachment" referent="4">
          <Properties>
            <string name="Name">Attachment</string>
            <BinaryString name="AttributesSerialize">
            </BinaryString>
            <CoordinateFrame name="CFrame">
              <X>0</X>
              <Y>0</Y>
              <Z>0</Z>
              <R00>1</R00>
              <R01>0</R01>
              <R02>0</R02>
              <R10>0</R10>
              <R11>1</R11>
              <R12>0</R12>
              <R20>0</R20>
              <R21>0</R21>
              <R22>1</R22>
            </CoordinateFrame>
            <int name="SourceAssetId">-1</int>
            <BinaryString name="Tags">
            </BinaryString>
            <bool name="Visible">false</bool>
          </Properties>
        </Item>
        <Item class="VectorForce" referent="5">
          <Properties>
            <string name="Name">VectorForce</string>
            <bool name="ApplyAtCenterOfMass">false</bool>
            <Ref name="Attachment0">null</Ref>
            <Ref name="Attachment1">null</Ref>
            <BinaryString name="AttributesSerialize">
            </BinaryString>
            <int name="Color">23</int>
            <bool name="Enabled">true</bool>
            <Vector3 name="Force">
              <X>1000</X>
              <Y>0</Y>
              <Z>0</Z>
            </Vector3>
            <token name="RelativeTo">0</token>
            <int name="SourceAssetId">-1</int>
            <BinaryString name="Tags">
            </BinaryString>
            <bool name="Visible">false</bool>
          </Properties>
        </Item>
      </Item>
    </Item>
  </Item>
  <Item class="ServerScriptService" referent="6">
    <Properties>
      <string name="Name">ServerScriptService</string>
    </Properties>
    <Item class="Folder" referent="7">
      <Properties>
        <string name="Name">server</string>
      </Properties>
      <Item class="Script" referent="8">
        <Properties>
          <string name="Name">BulletHandler</string>
          <string name="Source"><![CDATA[-- This script handles blaster projectiles on the server-side of the game
 
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")
 
-- Variables for RemoteEvents and Functions (see the BlasterHandler Script)
local launchProjectile = ReplicatedStorage:WaitForChild("LaunchProjectile")
local destroyProjectile = ReplicatedStorage:WaitForChild("DestroyProjectile")
local pingChecker = ReplicatedStorage:WaitForChild("Ping")
 
-- Variable to store the basic projectile object
local projectileTemplate = ReplicatedStorage.Bullet
-- Table to keep track of the ping of all connected clients
local currentPing = {}

-- This function is called when the client launches a projectile
launchProjectile.OnServerInvoke = function(player, cFrame, velocity)
	-- Consume a metal
	player.leaderstats.Metal.Value = player.leaderstats.Metal.Value -1
	
	-- Make a new projectile and set the velocity
	local projectile = projectileTemplate:Clone()
	projectile.Velocity = velocity
	
	-- Calculate where the projectile should be based on the latency
	-- of the player who launched it
	local ping = 0
	if currentPing[player] then
		ping = currentPing[player]
	end
	local offset = ping * velocity * 1.5
	projectile.CFrame = cFrame + offset
	
	-- Zero out gravity on the projectile so it doesn't fall through the ground
	local mass = projectile:GetMass()
	projectile.VectorForce.Force = Vector3.new(0, 1, 0) * mass * game.Workspace.Gravity
	
		
	-- Put the projectile in the workspace and make sure the server is the owner
	projectile.Parent = game.Workspace
	projectile:SetNetworkOwner(nil)
	
	Debris:AddItem(projectile, 1)
	
	-- Set up touched event for the projectile
	projectile.Touched:Connect(function(hit)
		-- if hit.Parent:FindFirstChild("Humanoid") and hit.Parent.Name ~= player.Name then
						print(hit.Name," ",hit.Parent.Name)
		if hit.Parent.Name ~= player.Name then
			projectile:Destroy()
			if hit.Parent:FindFirstChild("Humanoid") then 
				hit.Parent.Humanoid:TakeDamage(10)
				--print("Damage:",player.Name, " ", hit.Name, " ", hit.Parent.Name);
			end
		else
			--print("No damage:",player.Name, " ", hit.Name, " ", hit.Parent.Name);
		end
	end)

	
	-- Send the projectile back to the player who launched it
	return projectile
end
 
-- Called when the client detects a projectile should be destroyed
local function onDestroyProjectile(player, projectile)
	projectile:Destroy()
end
  
-- Called when a player joins the game. This function sets up a loop that
-- measures the ping of the player
local function onPlayerAdded(player)	
	while player and wait(2) do
		local start = tick()
		pingChecker:InvokeClient(player)
		local ping = tick() - start
		currentPing[player] = ping
	end
end
 
-- Called when a player leaves the game. Removes their entry from the
-- ping table
local function onPlayerRemoving(player)
	currentPing[player] = nil
end
 
-- Set up event bindings
destroyProjectile.OnServerEvent:Connect(onDestroyProjectile)
Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(onPlayerRemoving)
]]></string>
        </Properties>
      </Item>
    </Item>
  </Item>
  <Item class="SoundService" referent="9">
    <Properties>
      <string name="Name">SoundService</string>
      <bool name="RespectFilteringEnabled">true</bool>
    </Properties>
  </Item>
  <Item class="StarterPlayer" referent="10">
    <Properties>
      <string name="Name">StarterPlayer</string>
    </Properties>
    <Item class="StarterPlayerScripts" referent="11">
      <Properties>
        <string name="Name">StarterPlayerScripts</string>
      </Properties>
      <Item class="Folder" referent="12">
        <Properties>
          <string name="Name">client</string>
        </Properties>
        <Item class="LocalScript" referent="13">
          <Properties>
            <string name="Name">BulletLauncher</string>
            <string name="Source">-- This script handles blaster events on the client-side of the game

-- How fast the projectile moves
local PROJECTILE_SPEED = 80
-- How often a projectile can be made on mouse clicks (in seconds)
local LAUNCH_COOLDOWN = 0.1
 
-- Variables for Roblox services
local ContextActionService = game:GetService("ContextActionService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")
 
-- Variables for RemoteEvents and Functions (see the BulletHandler Script)
local launchProjectile = ReplicatedStorage:WaitForChild("LaunchProjectile")
local destroyProjectile = ReplicatedStorage:WaitForChild("DestroyProjectile")
local ping = ReplicatedStorage:WaitForChild("Ping")
 
-- Variable to store the basic projectile object
local projectileTemplate = ReplicatedStorage:WaitForChild("Bullet")
-- Variable for the player object
local player = Players.LocalPlayer
 
local canLaunch = true

local bulletSound = Instance.new("Sound")
bulletSound.SoundId = "http://www.roblox.com/asset/?id=1489924400"
bulletSound.Volume = 2.5
bulletSound.Looped = false
bulletSound.Parent = game.Workspace
 
local function onLaunch(actionName, inputState, inputObj)
	-- Only launch if the player's character exists and the blaster isn't on cooldown
	if inputState == Enum.UserInputState.Begin and canLaunch and player.Character and player.Character:FindFirstChild("Head") then
		-- Prevents the player from launching again until the cooldown is done
		canLaunch = false
		spawn(function()
			wait(LAUNCH_COOLDOWN)
			canLaunch = true
		end)
		
		-- Player direction: 
		-- -to the right = -1
		-- -to the left = +1
		local playerDirection = player.Character.HumanoidRootPart.RootMotor.Transform.RightVector.X
		
		-- Create a new projectile
		local projectile = projectileTemplate:Clone()
		local playerCFrame = player.Character.Head.CFrame -- Bullets are shooted by the cockpit (head).
		local direction = playerCFrame.RightVector -- Forward vector
		local random = math.random()/5 -- Randomise a little the direction of the bullets.
		direction = direction - playerDirection * playerCFrame.LookVector*random -- Bullets are slighlty aimed at the inside of the world.
		projectile.CFrame = playerCFrame * CFrame.Angles (0,playerDirection * math.pi/4*random,0) -- Rotate the bullet in accordance to its direction.
		projectile.Velocity = direction * PROJECTILE_SPEED
		
		-- Zero out gravity on the projectile so it doesn't fall through the ground
		local mass = projectile:GetMass()
		projectile.VectorForce.Force = Vector3.new(0, 1, 0) * mass * game.Workspace.Gravity
		
		-- Put the projectile in the workspace
		projectile.Parent = game.Workspace
		
		bulletSound:Play()
		
		-- Tell the server to create a new projectile and send it back to us
		local serverProjectile = launchProjectile:InvokeServer(projectile.CFrame, projectile.Velocity)
		-- Hide the server copy of the projectile
		serverProjectile.LocalTransparencyModifier = 1
		
		-- Set up touched event for the projectile
		projectile.Touched:Connect(function(hit)
			-- if hit.Parent:FindFirstChild("Humanoid") and hit.Parent.Name ~= player.Name then
			if hit.Name ~= 'Bullet' and hit.Parent.Name ~= player.Name then
				projectile:Destroy()
			end
		end)
		
		-- Life time of the projectile
		Debris:AddItem(projectile, 1)
	end
end
 
-- Connect a function to the ping RemoteFunction. This can be empty because all
-- the server needs to hear is a response
ping.OnClientInvoke = function() end

local function onFireGamepad()
	print("Fire Gamepad")
	onLaunch()
end

local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui") -- Wait PlayerGui to create touch button
ContextActionService:BindAction("Fire", onLaunch, true, Enum.KeyCode.Space)
ContextActionService:BindAction("FireGamepad", onFireGamepad, false, Enum.KeyCode.ButtonR2)
local fireButton = ContextActionService:GetButton("Fire")
if fireButton then -- we have a touch button
	local contextActionGui = playerGui:FindFirstChild("ContextActionGui")
	contextActionGui.ResetOnSpawn=false -- avoid destroy of the touch button when player resets.
end</string>
          </Properties>
        </Item>
      </Item>
    </Item>
  </Item>
  <Item class="Workspace" referent="14">
    <Properties>
      <string name="Name">Workspace</string>
      <bool name="FilteringEnabled">true</bool>
    </Properties>
    <Item class="Part" referent="15">
      <Properties>
        <string name="Name">Baseplate</string>
        <bool name="Anchored">true</bool>
        <Color3uint8 name="Color3uint8">6446690</Color3uint8>
        <bool name="Locked">true</bool>
        <Vector3 name="Position">
          <X>0</X>
          <Y>-10</Y>
          <Z>0</Z>
        </Vector3>
        <Vector3 name="size">
          <X>512</X>
          <Y>20</Y>
          <Z>512</Z>
        </Vector3>
      </Properties>
    </Item>
  </Item>
</roblox>